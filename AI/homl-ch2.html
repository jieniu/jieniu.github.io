<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>【学习笔记】Hands On Machine Learning - Chap2. End-to-End Machine Learning Project | 程序员在深圳</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/2.10.0/github-markdown.min.css">
    <meta name="description" content="一个程序员的工作学习日志">
    
    <link rel="preload" href="/assets/css/0.styles.f5338f93.css" as="style"><link rel="preload" href="/assets/js/app.df58ad8f.js" as="script"><link rel="preload" href="/assets/js/2.61eaf15d.js" as="script"><link rel="preload" href="/assets/js/19.572b0672.js" as="script"><link rel="prefetch" href="/assets/js/10.f87ecc1f.js"><link rel="prefetch" href="/assets/js/11.54366349.js"><link rel="prefetch" href="/assets/js/12.67a0f6b0.js"><link rel="prefetch" href="/assets/js/13.99b5efa8.js"><link rel="prefetch" href="/assets/js/14.d6c4161c.js"><link rel="prefetch" href="/assets/js/15.86108684.js"><link rel="prefetch" href="/assets/js/16.010195ae.js"><link rel="prefetch" href="/assets/js/17.ce5baee3.js"><link rel="prefetch" href="/assets/js/18.aadd0b94.js"><link rel="prefetch" href="/assets/js/20.b6be1672.js"><link rel="prefetch" href="/assets/js/21.cd98384f.js"><link rel="prefetch" href="/assets/js/22.102317c8.js"><link rel="prefetch" href="/assets/js/23.a0861652.js"><link rel="prefetch" href="/assets/js/24.bf902e0e.js"><link rel="prefetch" href="/assets/js/25.07e70736.js"><link rel="prefetch" href="/assets/js/26.3217ccfc.js"><link rel="prefetch" href="/assets/js/27.234cd32e.js"><link rel="prefetch" href="/assets/js/28.7c7054a6.js"><link rel="prefetch" href="/assets/js/29.f9081eeb.js"><link rel="prefetch" href="/assets/js/3.b3b53faa.js"><link rel="prefetch" href="/assets/js/30.8e61b67c.js"><link rel="prefetch" href="/assets/js/31.6c587718.js"><link rel="prefetch" href="/assets/js/32.dc610c44.js"><link rel="prefetch" href="/assets/js/33.dcbd6e39.js"><link rel="prefetch" href="/assets/js/34.ae1fd795.js"><link rel="prefetch" href="/assets/js/35.138d4346.js"><link rel="prefetch" href="/assets/js/36.d31f5a6a.js"><link rel="prefetch" href="/assets/js/37.a3169296.js"><link rel="prefetch" href="/assets/js/38.aca3097a.js"><link rel="prefetch" href="/assets/js/39.c0de7ac0.js"><link rel="prefetch" href="/assets/js/4.e59358e7.js"><link rel="prefetch" href="/assets/js/40.5d68e63a.js"><link rel="prefetch" href="/assets/js/41.3dca7ff0.js"><link rel="prefetch" href="/assets/js/42.315116b4.js"><link rel="prefetch" href="/assets/js/43.cef3d9f5.js"><link rel="prefetch" href="/assets/js/44.88ac8ba1.js"><link rel="prefetch" href="/assets/js/45.73ffc9a4.js"><link rel="prefetch" href="/assets/js/46.04780877.js"><link rel="prefetch" href="/assets/js/47.f20a8844.js"><link rel="prefetch" href="/assets/js/48.e649e8cd.js"><link rel="prefetch" href="/assets/js/49.8a3b5784.js"><link rel="prefetch" href="/assets/js/5.1b393789.js"><link rel="prefetch" href="/assets/js/50.1a49c4ab.js"><link rel="prefetch" href="/assets/js/51.cbf7b21b.js"><link rel="prefetch" href="/assets/js/52.7788643e.js"><link rel="prefetch" href="/assets/js/53.e05e9f77.js"><link rel="prefetch" href="/assets/js/54.afd8b938.js"><link rel="prefetch" href="/assets/js/55.563d7429.js"><link rel="prefetch" href="/assets/js/56.b7fa3e85.js"><link rel="prefetch" href="/assets/js/57.f1a89935.js"><link rel="prefetch" href="/assets/js/58.15388447.js"><link rel="prefetch" href="/assets/js/59.372e5f15.js"><link rel="prefetch" href="/assets/js/6.b798fcf5.js"><link rel="prefetch" href="/assets/js/60.a488faa3.js"><link rel="prefetch" href="/assets/js/61.76dadce9.js"><link rel="prefetch" href="/assets/js/62.21c77b63.js"><link rel="prefetch" href="/assets/js/63.5e49c47d.js"><link rel="prefetch" href="/assets/js/64.453510d9.js"><link rel="prefetch" href="/assets/js/65.993d90cc.js"><link rel="prefetch" href="/assets/js/66.4cab5d50.js"><link rel="prefetch" href="/assets/js/67.868bf75e.js"><link rel="prefetch" href="/assets/js/68.89613fc8.js"><link rel="prefetch" href="/assets/js/69.779e7f70.js"><link rel="prefetch" href="/assets/js/7.cb2f8a10.js"><link rel="prefetch" href="/assets/js/70.6b66c1a9.js"><link rel="prefetch" href="/assets/js/71.9783ef6a.js"><link rel="prefetch" href="/assets/js/72.5e7137bc.js"><link rel="prefetch" href="/assets/js/73.9fcb00bc.js"><link rel="prefetch" href="/assets/js/74.3a440a9c.js"><link rel="prefetch" href="/assets/js/8.01f6304b.js"><link rel="prefetch" href="/assets/js/9.e15aa5e8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f5338f93.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">程序员在深圳</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/cpp/" class="nav-link">
  C++
</a></div><div class="nav-item"><a href="/java/" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/AI/" class="nav-link router-link-active">
  AI
</a></div><div class="nav-item"><a href="/math/" class="nav-link">
  math
</a></div><div class="nav-item"><a href="/mysql_notes/" class="nav-link">
  mysql
</a></div><div class="nav-item"><a href="/tools/" class="nav-link">
  tools
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="LeetCode" class="dropdown-title"><span class="title">LeetCode</span> <span class="arrow down"></span></button> <button type="button" aria-label="LeetCode" class="mobile-dropdown-title"><span class="title">LeetCode</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/leetcode/" class="nav-link">
  articles
</a></li><li class="dropdown-item"><!----> <a href="https://github.com/jieniu/LeetCode.git" target="_blank" rel="noopener noreferrer" class="nav-link external">
  MyLeeCode
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <a href="https://github.com/jieniu/articles" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/cpp/" class="nav-link">
  C++
</a></div><div class="nav-item"><a href="/java/" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/AI/" class="nav-link router-link-active">
  AI
</a></div><div class="nav-item"><a href="/math/" class="nav-link">
  math
</a></div><div class="nav-item"><a href="/mysql_notes/" class="nav-link">
  mysql
</a></div><div class="nav-item"><a href="/tools/" class="nav-link">
  tools
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="LeetCode" class="dropdown-title"><span class="title">LeetCode</span> <span class="arrow down"></span></button> <button type="button" aria-label="LeetCode" class="mobile-dropdown-title"><span class="title">LeetCode</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/leetcode/" class="nav-link">
  articles
</a></li><li class="dropdown-item"><!----> <a href="https://github.com/jieniu/LeetCode.git" target="_blank" rel="noopener noreferrer" class="nav-link external">
  MyLeeCode
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <a href="https://github.com/jieniu/articles" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="【学习笔记】hands-on-machine-learning-chap2-end-to-end-machine-learning-project"><a href="#【学习笔记】hands-on-machine-learning-chap2-end-to-end-machine-learning-project" class="header-anchor">#</a> 【学习笔记】Hands On Machine Learning - Chap2. End-to-End Machine Learning Project</h1> <p>从标题可以看出，这一章主要从大的方向，介绍机器学习的一般步骤，虽然是介绍性的知识，但不乏一些有价值的内容，以下几点是我个人的总结：</p> <p><strong>数据预览：</strong></p> <ol><li>预览前 5 条数据，有个直观的感受</li> <li>查看数据总行数，字段类型，每个字段的非空行数</li> <li>查看分类字段的分布情况</li> <li>查看数据字段的均值、方差、最小值、最大值、25/50/75分位值</li> <li>查看数据字段的分布（最好是图形）</li></ol> <p><strong>测试集创建：</strong></p> <ol><li>数据量大的情况下可以通过随机的方式创建数据集</li> <li>数据量不大的情况下，需要使用分层抽样，确保样本数据和真实数据具有一样的分层分布，避免产生采样偏差</li></ol> <p><strong>数据分析</strong></p> <ul><li>对属性和目标字段做相关性分析</li> <li>属性组合：在属性组合后，再做一次相关性分析，查看组合后的属性的相关性是否变强</li> <li>对于长尾型数据，做 log 处理</li></ul> <p><strong>数据清洗</strong></p> <ul><li>空值填充</li> <li>处理文字类型属性
<ul><li>label encoding 对有顺序关系的字段进行编码</li> <li>one-hot encoding 对非顺序关系的字段进行编码</li></ul></li></ul> <p><strong>特征工程</strong></p> <ul><li><strong>归一化在异常值干扰方面没有标准化好</strong></li></ul> <p><strong>选择模型进行训练</strong></p> <ul><li><p>欠拟合的解决方案</p> <ul><li>选择一个更复杂的模型</li> <li>增加其他更好的特征</li> <li>减少模型限制，例如去掉正则化</li></ul></li> <li><p>过拟合的解决方案</p> <ul><li>简化模型</li> <li>使用正则化</li> <li>加大训练数据</li></ul></li> <li><p>使用交叉验证评估模型，检查模型的泛化能力</p></li> <li><p>使用 Grid Search 方法来选择一组较好的超参组合</p></li> <li><p>训练后，使用特征重要性分析，将无关紧要的特征去掉，之后可以再加入新特征，重新训练，直到得到满意的模型</p></li></ul> <p><strong>上线前的总结</strong></p> <ul><li>从实验中学到了什么</li> <li>什么可行和不可行</li> <li>本实验中有哪些假设</li> <li>该实验有哪些限制</li></ul> <p><strong>上线时需要注意什么</strong></p> <ul><li>持续监控，避免因数据的持续更新，导致模型的退化</li> <li>采样预测数据，并对其进行评估，监控模型效果</li> <li>定期重新训练模型，如 6 个月</li> <li>定期全量预测</li></ul> <p>以下是具体的笔记内容：</p> <h2 id="数据集方面"><a href="#数据集方面" class="header-anchor">#</a> 数据集方面</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> os
<span class="token keyword">import</span> tarfile
<span class="token keyword">from</span> six<span class="token punctuation">.</span>moves <span class="token keyword">import</span> urllib

DOWNLOAD_ROOT <span class="token operator">=</span> <span class="token string">&quot;https://raw.githubusercontent.com/ageron/handson-ml/master/&quot;</span>
HOUSING_PATH <span class="token operator">=</span> <span class="token string">&quot;datasets/housing&quot;</span>
HOUSING_URL <span class="token operator">=</span> DOWNLOAD_ROOT <span class="token operator">+</span> HOUSING_PATH <span class="token operator">+</span> <span class="token string">&quot;/housing.tgz&quot;</span>

<span class="token keyword">def</span> <span class="token function">fetch_housing_data</span><span class="token punctuation">(</span>housing_url<span class="token operator">=</span>HOUSING_URL<span class="token punctuation">,</span> housing_path<span class="token operator">=</span>HOUSING_PATH<span class="token punctuation">)</span><span class="token punctuation">:</span> 
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span>housing_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
             os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>housing_path<span class="token punctuation">)</span>
    tgz_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>housing_path<span class="token punctuation">,</span> <span class="token string">&quot;housing.tgz&quot;</span><span class="token punctuation">)</span>
    urllib<span class="token punctuation">.</span>request<span class="token punctuation">.</span>urlretrieve<span class="token punctuation">(</span>housing_url<span class="token punctuation">,</span> tgz_path<span class="token punctuation">)</span>
    housing_tgz <span class="token operator">=</span> tarfile<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>tgz_path<span class="token punctuation">)</span>
    housing_tgz<span class="token punctuation">.</span>extractall<span class="token punctuation">(</span>path<span class="token operator">=</span>housing_path<span class="token punctuation">)</span>
    housing_tgz<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
<span class="token comment"># 下载数据</span>
fetch_housing_data<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="数据总览"><a href="#数据总览" class="header-anchor">#</a> 数据总览</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">def</span> <span class="token function">load_housing_data</span><span class="token punctuation">(</span>housing_path<span class="token operator">=</span>HOUSING_PATH<span class="token punctuation">)</span><span class="token punctuation">:</span> 
    csv_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>housing_path<span class="token punctuation">,</span> <span class="token string">&quot;housing.csv&quot;</span><span class="token punctuation">)</span> 
    <span class="token keyword">return</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>csv_path<span class="token punctuation">)</span>

<span class="token comment"># 查看前 5 条数据</span>
housing <span class="token operator">=</span> load_housing_data<span class="token punctuation">(</span><span class="token punctuation">)</span>
housing<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="https://github.com/jieniu/articles/blob/master/docs/.vuepress/public/image-20190523220534082.png?raw=true" alt=""></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 查看总行数，列类型，各列的非空条数，注意到 total_bedrooms 存在空记录</span>
housing<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
<span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token string">'pandas.core.frame.DataFrame'</span><span class="token operator">&gt;</span>
RangeIndex<span class="token punctuation">:</span> <span class="token number">20640</span> entries<span class="token punctuation">,</span> <span class="token number">0</span> to <span class="token number">20639</span>
Data columns <span class="token punctuation">(</span>total <span class="token number">10</span> columns<span class="token punctuation">)</span><span class="token punctuation">:</span>
longitude             <span class="token number">20640</span> non<span class="token operator">-</span>null float64
latitude              <span class="token number">20640</span> non<span class="token operator">-</span>null float64
housing_median_age    <span class="token number">20640</span> non<span class="token operator">-</span>null float64
total_rooms           <span class="token number">20640</span> non<span class="token operator">-</span>null float64
total_bedrooms        <span class="token number">20433</span> non<span class="token operator">-</span>null float64
population            <span class="token number">20640</span> non<span class="token operator">-</span>null float64
households            <span class="token number">20640</span> non<span class="token operator">-</span>null float64
median_income         <span class="token number">20640</span> non<span class="token operator">-</span>null float64
median_house_value    <span class="token number">20640</span> non<span class="token operator">-</span>null float64
ocean_proximity       <span class="token number">20640</span> non<span class="token operator">-</span>null <span class="token builtin">object</span>
dtypes<span class="token punctuation">:</span> float64<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">object</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
memory usage<span class="token punctuation">:</span> <span class="token number">1.6</span><span class="token operator">+</span> MB
  
<span class="token comment"># 查看分类数据的分布情况</span>
housing<span class="token punctuation">[</span><span class="token string">&quot;ocean_proximity&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value_counts<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
<span class="token operator">&lt;</span>1H OCEAN     <span class="token number">9136</span>
INLAND        <span class="token number">6551</span>
NEAR OCEAN    <span class="token number">2658</span>
NEAR BAY      <span class="token number">2290</span>
ISLAND           <span class="token number">5</span>
Name<span class="token punctuation">:</span> ocean_proximity<span class="token punctuation">,</span> dtype<span class="token punctuation">:</span> int64
    
<span class="token comment"># 查看数字字段的概览</span>
housing<span class="token punctuation">.</span>describe<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="https://github.com/jieniu/articles/blob/master/docs/.vuepress/public/image-20190523220729885.png?raw=true" alt=""></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#This tells Jupyter to set up Matplotlib so it uses Jupyter’s own backend.</span>
<span class="token operator">%</span>matplotlib inline 
<span class="token comment"># 输出所有数字属性的分布情况</span>
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt 
housing<span class="token punctuation">.</span>hist<span class="token punctuation">(</span>bins<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="https://github.com/jieniu/articles/blob/master/docs/.vuepress/public/image-20190523220801771.png?raw=true" alt=""></p> <h3 id="创建测试集"><a href="#创建测试集" class="header-anchor">#</a> 创建测试集</h3> <p>测试集样本要有代表性，能反映真实情况，否则会造成采样偏差，这是很容易被忽视的部分</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 数据量相对大的情况下（相对于特征数来说），随机的方法是可行的，否则会产生抽样偏差</span>
<span class="token comment"># 分层抽样，样本各类别的比例要符合真实情况，例如实际男女比例为6:4，那么样本中男:女就应该为6:4</span>
<span class="token comment"># 要保证测试集符合真实情况，假设收入是预测房价的重要特征，你就需要确保测试集具有和真实情况同样的收入分布</span>
<span class="token comment"># 构造收入分类属性</span>
housing<span class="token punctuation">[</span><span class="token string">&quot;income_cat&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>ceil<span class="token punctuation">(</span>housing<span class="token punctuation">[</span><span class="token string">&quot;median_income&quot;</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">1.5</span><span class="token punctuation">)</span>
housing<span class="token punctuation">[</span><span class="token string">&quot;income_cat&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>where<span class="token punctuation">(</span>housing<span class="token punctuation">[</span><span class="token string">&quot;income_cat&quot;</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5.0</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token comment"># sklearn 的分层抽样方法</span>
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> StratifiedShuffleSplit
split <span class="token operator">=</span> StratifiedShuffleSplit<span class="token punctuation">(</span>n_splits<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> test_size<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">42</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> train_index<span class="token punctuation">,</span> test_index <span class="token keyword">in</span> split<span class="token punctuation">.</span>split<span class="token punctuation">(</span>housing<span class="token punctuation">,</span> housing<span class="token punctuation">[</span><span class="token string">&quot;income_cat&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    strat_train_set <span class="token operator">=</span> housing<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>train_index<span class="token punctuation">]</span>
    strat_test_set <span class="token operator">=</span> housing<span class="token punctuation">.</span>loc<span class="token punctuation">[</span>test_index<span class="token punctuation">]</span>
housing<span class="token punctuation">[</span><span class="token string">&quot;income_cat&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value_counts<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>housing<span class="token punctuation">)</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
<span class="token number">3.0</span>    <span class="token number">0.350581</span>
<span class="token number">2.0</span>    <span class="token number">0.318847</span>
<span class="token number">4.0</span>    <span class="token number">0.176308</span>
<span class="token number">5.0</span>    <span class="token number">0.114438</span>
<span class="token number">1.0</span>    <span class="token number">0.039826</span>
Name<span class="token punctuation">:</span> income_cat<span class="token punctuation">,</span> dtype<span class="token punctuation">:</span> float64
    
<span class="token comment"># remove income_cat attr</span>
<span class="token keyword">for</span> <span class="token builtin">set</span> <span class="token keyword">in</span> <span class="token punctuation">(</span>strat_train_set<span class="token punctuation">,</span> strat_test_set<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">set</span><span class="token punctuation">.</span>drop<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;income_cat&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="深入探索和将数据可视化"><a href="#深入探索和将数据可视化" class="header-anchor">#</a> 深入探索和将数据可视化</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 复制数据，将其可视化</span>
housing <span class="token operator">=</span> strat_train_set<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 以地理位置画散点图</span>
housing<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>kind<span class="token operator">=</span><span class="token string">&quot;scatter&quot;</span><span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token string">&quot;longitude&quot;</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token string">&quot;latitude&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="https://github.com/jieniu/articles/blob/master/docs/.vuepress/public/image-20190523221326162.png?raw=true" alt=""></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 设置透明度，可显示数据稠密地区</span>
housing<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>kind<span class="token operator">=</span><span class="token string">&quot;scatter&quot;</span><span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token string">&quot;longitude&quot;</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token string">&quot;latitude&quot;</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="https://github.com/jieniu/articles/blob/master/docs/.vuepress/public/image-20190523221350684.png?raw=true" alt=""></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 添加人口和房价信息</span>
housing<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>kind<span class="token operator">=</span><span class="token string">&quot;scatter&quot;</span><span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token string">&quot;longitude&quot;</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token string">&quot;latitude&quot;</span><span class="token punctuation">,</span> alpha<span class="token operator">=</span><span class="token number">0.4</span><span class="token punctuation">,</span>
         s<span class="token operator">=</span>housing<span class="token punctuation">[</span><span class="token string">&quot;population&quot;</span><span class="token punctuation">]</span><span class="token operator">/</span><span class="token number">100</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">&quot;population&quot;</span><span class="token punctuation">,</span>
         c<span class="token operator">=</span><span class="token string">&quot;median_house_value&quot;</span><span class="token punctuation">,</span> cmap<span class="token operator">=</span>plt<span class="token punctuation">.</span>get_cmap<span class="token punctuation">(</span><span class="token string">&quot;jet&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> colorbar<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
     <span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="https://github.com/jieniu/articles/blob/master/docs/.vuepress/public/image-20190523221419588.png?raw=true" alt=""></p> <h3 id="相关性分析"><a href="#相关性分析" class="header-anchor">#</a> 相关性分析</h3> <p>计算属性间的相关性 - standard correlation coefficient (Pearson's r)，属性间是否相关可参考以下图示</p> <p><img src="https://github.com/jieniu/articles/blob/master/docs/.vuepress/public/scc.png?raw=true" alt=""></p> <p><strong>注意：最底下的图形为非线性关系</strong></p> <div class="language-python extra-class"><pre class="language-python"><code>corr_matrix <span class="token operator">=</span> housing<span class="token punctuation">.</span>corr<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 查看属性和房价的相关性</span>
corr_matrix<span class="token punctuation">[</span><span class="token string">&quot;median_house_value&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>ascending<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
median_house_value    <span class="token number">1.000000</span>
median_income         <span class="token number">0.687160</span>
total_rooms           <span class="token number">0.135097</span>
housing_median_age    <span class="token number">0.114110</span>
households            <span class="token number">0.064506</span>
total_bedrooms        <span class="token number">0.047689</span>
population           <span class="token operator">-</span><span class="token number">0.026920</span>
longitude            <span class="token operator">-</span><span class="token number">0.047432</span>
latitude             <span class="token operator">-</span><span class="token number">0.142724</span>
Name<span class="token punctuation">:</span> median_house_value<span class="token punctuation">,</span> dtype<span class="token punctuation">:</span> float64
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 使用 pandas' scatter_matrix 函数来查看两两属性的相关性</span>
<span class="token keyword">from</span> pandas<span class="token punctuation">.</span>tools<span class="token punctuation">.</span>plotting <span class="token keyword">import</span> scatter_matrix
attributes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;median_house_value&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;median_income&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;total_rooms&quot;</span><span class="token punctuation">,</span>
                  <span class="token string">&quot;housing_median_age&quot;</span><span class="token punctuation">]</span>
scatter_matrix<span class="token punctuation">(</span>housing<span class="token punctuation">[</span>attributes<span class="token punctuation">]</span><span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="https://github.com/jieniu/articles/blob/master/docs/.vuepress/public/image-20190523221906362.png?raw=true" alt=""></p> <h3 id="属性组合"><a href="#属性组合" class="header-anchor">#</a> 属性组合</h3> <ul><li>对于长尾属性，可以对其进行 log 处理</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 添加组合属性</span>
housing<span class="token punctuation">[</span><span class="token string">&quot;rooms_per_household&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> housing<span class="token punctuation">[</span><span class="token string">&quot;total_rooms&quot;</span><span class="token punctuation">]</span><span class="token operator">/</span>housing<span class="token punctuation">[</span><span class="token string">&quot;households&quot;</span><span class="token punctuation">]</span>
housing<span class="token punctuation">[</span><span class="token string">&quot;bedrooms_per_room&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> housing<span class="token punctuation">[</span><span class="token string">&quot;total_bedrooms&quot;</span><span class="token punctuation">]</span><span class="token operator">/</span>housing<span class="token punctuation">[</span><span class="token string">&quot;total_rooms&quot;</span><span class="token punctuation">]</span>
housing<span class="token punctuation">[</span><span class="token string">&quot;population_per_household&quot;</span><span class="token punctuation">]</span><span class="token operator">=</span>housing<span class="token punctuation">[</span><span class="token string">&quot;population&quot;</span><span class="token punctuation">]</span><span class="token operator">/</span>housing<span class="token punctuation">[</span><span class="token string">&quot;households&quot;</span><span class="token punctuation">]</span>
<span class="token comment"># 继续查看相关性，可以看到 bedrooms_per_room 比 total_bedrooms 和 total_rooms 相关性都高</span>
corr_matrix <span class="token operator">=</span> housing<span class="token punctuation">.</span>corr<span class="token punctuation">(</span><span class="token punctuation">)</span>
corr_matrix<span class="token punctuation">[</span><span class="token string">&quot;median_house_value&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span>ascending<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
median_house_value          <span class="token number">1.000000</span>
median_income               <span class="token number">0.687160</span>
rooms_per_household         <span class="token number">0.146285</span>
total_rooms                 <span class="token number">0.135097</span>
housing_median_age          <span class="token number">0.114110</span>
households                  <span class="token number">0.064506</span>
total_bedrooms              <span class="token number">0.047689</span>
population_per_household   <span class="token operator">-</span><span class="token number">0.021985</span>
population                 <span class="token operator">-</span><span class="token number">0.026920</span>
longitude                  <span class="token operator">-</span><span class="token number">0.047432</span>
latitude                   <span class="token operator">-</span><span class="token number">0.142724</span>
bedrooms_per_room          <span class="token operator">-</span><span class="token number">0.259984</span>
Name<span class="token punctuation">:</span> median_house_value<span class="token punctuation">,</span> dtype<span class="token punctuation">:</span> float64
</code></pre></div><h2 id="机器学习准备"><a href="#机器学习准备" class="header-anchor">#</a> 机器学习准备</h2> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 将 label 分离，drop 操作的是复制的数据，不会影响原数据</span>
housing <span class="token operator">=</span> strat_train_set<span class="token punctuation">.</span>drop<span class="token punctuation">(</span><span class="token string">&quot;median_house_value&quot;</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
housing_labels <span class="token operator">=</span> strat_train_set<span class="token punctuation">[</span><span class="token string">&quot;median_house_value&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="数据清洗"><a href="#数据清洗" class="header-anchor">#</a> 数据清洗</h3> <ol><li>空值填充</li></ol> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 方法1：删除含空值的记录</span>
<span class="token comment">#housing.dropna(subset=[&quot;total_bedrooms&quot;])</span>
<span class="token comment"># 方法2：删除所有属性 </span>
<span class="token comment">#housing.drop(&quot;total_bedrooms&quot;, axis=1)</span>
<span class="token comment"># 方法3：用（0、中值、平均值等）填充空值</span>
median <span class="token operator">=</span> housing<span class="token punctuation">[</span><span class="token string">&quot;total_bedrooms&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>median<span class="token punctuation">(</span><span class="token punctuation">)</span>
housing<span class="token punctuation">[</span><span class="token string">&quot;total_bedrooms&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fillna<span class="token punctuation">(</span>median<span class="token punctuation">)</span>

<span class="token comment"># 你也可以使用 Imputer</span>
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span> Imputer
imputer <span class="token operator">=</span> Imputer<span class="token punctuation">(</span>strategy<span class="token operator">=</span><span class="token string">&quot;median&quot;</span><span class="token punctuation">)</span>
housing_num <span class="token operator">=</span> housing<span class="token punctuation">.</span>drop<span class="token punctuation">(</span><span class="token string">&quot;ocean_proximity&quot;</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># imputer只能用于数字字段上</span>
imputer<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>housing_num<span class="token punctuation">)</span>

imputer<span class="token punctuation">.</span>statistics_
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">118.51</span>  <span class="token punctuation">,</span>   <span class="token number">34.26</span>  <span class="token punctuation">,</span>   <span class="token number">29</span><span class="token punctuation">.</span>    <span class="token punctuation">,</span> <span class="token number">2119.5</span>   <span class="token punctuation">,</span>  <span class="token number">433</span><span class="token punctuation">.</span>    <span class="token punctuation">,</span> <span class="token number">1164</span><span class="token punctuation">.</span>    <span class="token punctuation">,</span>
        <span class="token number">408</span><span class="token punctuation">.</span>    <span class="token punctuation">,</span>    <span class="token number">3.5409</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 将 imputer 应用到数据中</span>
X <span class="token operator">=</span> imputer<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>housing_num<span class="token punctuation">)</span>
<span class="token comment"># 将输出结果转换为 Pandas Dataframe 格式</span>
housing_tr <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>X<span class="token punctuation">,</span> columns<span class="token operator">=</span>housing_num<span class="token punctuation">.</span>columns<span class="token punctuation">)</span>
</code></pre></div><h3 id="scikit-learn-的设计原则"><a href="#scikit-learn-的设计原则" class="header-anchor">#</a> Scikit-Learn 的设计原则</h3> <ul><li><strong>一致性</strong>：所有对象保持一致且简单的接口
<ul><li>Estimators: 可以基于数据训练参数的对象称为 estimator, 例如：imputer 是一个 estimator，训练使用 <code>fit()</code> 函数完成。超参数：除数据源和 label 外的其他参数</li> <li>Transformers: 能作用于数据上且对数据做出改变的 estimators 被称为 transformers，API 为 <code>transform()</code>；<code>fit_transform()</code> 等价于 <code>fit()</code> 和 <code>transform()</code></li> <li>Predictors: 可以对数据进行预测的 estimators 被称为 predictors，例如 LinearRegression 模型，predictors 提供一个 <code>predict()</code> 接口，同时还提供 <code>score()</code> 接口，用来衡量预测的质量</li></ul></li> <li><strong>可检查</strong>：所有 estimators 的超参数都可通过公有成员访问，例如 <code>imputer.stategy</code>，训练参数也可以通过带下划线的公有成员访问，例如 <code>imputer.statistics_</code></li> <li><strong>类型友好</strong>：数据集由 NumPy 数组或 SciPy 稀疏矩阵表示</li> <li><strong>可组合</strong>：很容易构建 Pipeline estimator</li> <li><strong>良好的默认行为</strong>：对大多数参数来说，都提供一个合理的默认值，这样很容易创建一个基准版本</li></ul> <h3 id="处理文字及分类属性"><a href="#处理文字及分类属性" class="header-anchor">#</a> 处理文字及分类属性</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># labelEncoder</span>
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span> LabelEncoder
encoder <span class="token operator">=</span> LabelEncoder<span class="token punctuation">(</span><span class="token punctuation">)</span>
housing_cat <span class="token operator">=</span> housing<span class="token punctuation">[</span><span class="token string">&quot;ocean_proximity&quot;</span><span class="token punctuation">]</span>
housing_cat_encoded <span class="token operator">=</span> encoder<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>housing_cat<span class="token punctuation">)</span>
housing_cat_encoded
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>labelEncoder 的问题问题在于两个相邻的数值被认为是相近的，但很明显在大多数情况下这种编码方式比较随机，无法体现顺序关系，解决办法是使用 one-hot 编码</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span> OneHotEncoder
encoder <span class="token operator">=</span> OneHotEncoder<span class="token punctuation">(</span><span class="token punctuation">)</span>
housing_cat_1hot <span class="token operator">=</span> encoder<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>housing_cat_encoded<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
housing_cat_1hot <span class="token comment"># 返回值是一个 sparse 矩阵，sparse 矩阵只存储了有效信息，可节省空间</span>

<span class="token comment"># 转换为 dense 矩阵</span>
housing_cat_1hot<span class="token punctuation">.</span>toarray<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 直接返回 dense 矩阵，如果想得到 sparse 矩阵，将 `sparse_output=True` 设入 `LabelBinarizer` 构造函数</span>
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span> LabelBinarizer
encoder <span class="token operator">=</span> LabelBinarizer<span class="token punctuation">(</span><span class="token punctuation">)</span>
housing_cat_1hot <span class="token operator">=</span> encoder<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>housing_cat<span class="token punctuation">)</span>
housing_cat_1hot
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
       <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="自定义-transformers"><a href="#自定义-transformers" class="header-anchor">#</a> 自定义 Transformers</h3> <ol><li>实现 <code>fit()</code>、<code>transform()</code>、<code>fit_transform()</code> 接口</li> <li>继承 TransformerMixin 后会自动拥有 <code>fit_transform()</code> 接口</li> <li>继承 BaseEstimator 类后会获得额外的 <code>get_params()</code> 和 <code>set_params()</code> 接口</li></ol> <p>例子如下：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 该例子可以让你设置一个超参数，以告诉你增加某个特征是否能对模型有帮助</span>
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>base <span class="token keyword">import</span> BaseEstimator<span class="token punctuation">,</span> TransformerMixin
rooms_ix<span class="token punctuation">,</span> bedrooms_ix<span class="token punctuation">,</span> population_ix<span class="token punctuation">,</span> household_ix <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span>

<span class="token keyword">class</span> <span class="token class-name">CombinedAttributesAdder</span><span class="token punctuation">(</span>BaseEstimator<span class="token punctuation">,</span> TransformerMixin<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> add_bedrooms_per_room <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># no *args or **kargs</span>
        self<span class="token punctuation">.</span>add_bedrooms_per_room <span class="token operator">=</span> add_bedrooms_per_room
    <span class="token keyword">def</span> <span class="token function">fit</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> X<span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self <span class="token comment"># nothing else to do</span>
    <span class="token keyword">def</span> <span class="token function">transform</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> X<span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        rooms_per_household <span class="token operator">=</span> X<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> rooms_ix<span class="token punctuation">]</span> <span class="token operator">/</span> X<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> household_ix<span class="token punctuation">]</span>
        population_per_household <span class="token operator">=</span> X<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> population_ix<span class="token punctuation">]</span> <span class="token operator">/</span> X<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> household_ix<span class="token punctuation">]</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>add_bedrooms_per_room<span class="token punctuation">:</span>
            bedrooms_per_room <span class="token operator">=</span> X<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> bedrooms_ix<span class="token punctuation">]</span> <span class="token operator">/</span> X<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> rooms_ix<span class="token punctuation">]</span>
            <span class="token keyword">return</span> np<span class="token punctuation">.</span>c_<span class="token punctuation">[</span>X<span class="token punctuation">,</span> rooms_per_household<span class="token punctuation">,</span> population_per_household<span class="token punctuation">,</span>
                         bedrooms_per_room<span class="token punctuation">]</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> np<span class="token punctuation">.</span>c_<span class="token punctuation">[</span>X<span class="token punctuation">,</span> rooms_per_household<span class="token punctuation">,</span> population_per_household<span class="token punctuation">]</span>
    
    
attr_adder <span class="token operator">=</span> CombinedAttributesAdder<span class="token punctuation">(</span>add_bedrooms_per_room<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
housing_extra_attribs <span class="token operator">=</span> attr_adder<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>housing<span class="token punctuation">.</span>values<span class="token punctuation">)</span>
</code></pre></div><h3 id="feature-scaling"><a href="#feature-scaling" class="header-anchor">#</a> Feature Scaling</h3> <ul><li>min-max scaling: end up ranging from 0 to 1; SK-Learn: <code>MinMaxScaler</code>; <code>feature_range</code> let you change the range if you don't want 0-1 for some reason.</li> <li>standardization: <strong>standardization 不会受到异常值的干扰</strong>，例如：假设异常值为 100，Min-Max 会使所有的值从 0-15 归档到 0-0.15，而标准化不会太受该异常值干扰。SK-Learn：<code>StandardScaler</code></li></ul> <p>scalers 只应该作用于训练集，不应作用于测试集和预测集</p> <h3 id="transformation-pipelines"><a href="#transformation-pipelines" class="header-anchor">#</a> Transformation Pipelines</h3> <p>Pipeline 将每个 transformer 的输出作为下一个 transformer 的输入，下面是运用在数字属性上的 pipeline 的例子</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>pipeline <span class="token keyword">import</span> Pipeline
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span> StandardScaler

num_pipeline <span class="token operator">=</span> Pipeline<span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token comment"># (name,estimator) 对，名字可以随便起</span>
            <span class="token comment"># 除最后一个外，所有 estimators 必须为 transformers （实现了 fit_transform() 方法）</span>
            <span class="token punctuation">(</span><span class="token string">'imputer'</span><span class="token punctuation">,</span> Imputer<span class="token punctuation">(</span>strategy<span class="token operator">=</span><span class="token string">&quot;median&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token string">'attribs_adder'</span><span class="token punctuation">,</span> CombinedAttributesAdder<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token string">'std_scaler'</span><span class="token punctuation">,</span> StandardScaler<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
        <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># pipeline 对象调用的方法和最后一个 estimator 的方法对应</span>
housing_num_tr <span class="token operator">=</span> num_pipeline<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>housing_num<span class="token punctuation">)</span>
</code></pre></div><h4 id="featureunion"><a href="#featureunion" class="header-anchor">#</a> FeatureUnion</h4> <p>当又要处理数字特征，又要处理文字特征时，可使用 FeatureUnion，它让多个 pipeline 并行执行，当全部执行结束时，再将它们 concat 起来一起返回</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>pipeline <span class="token keyword">import</span> FeatureUnion
<span class="token keyword">from</span> sklearn_features<span class="token punctuation">.</span>transformers <span class="token keyword">import</span> DataFrameSelector

num_attribs <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>housing_num<span class="token punctuation">)</span>
cat_attribs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;ocean_proximity&quot;</span><span class="token punctuation">]</span>

num_pipeline <span class="token operator">=</span> Pipeline<span class="token punctuation">(</span><span class="token punctuation">[</span>
             <span class="token punctuation">(</span><span class="token string">'selector'</span><span class="token punctuation">,</span> DataFrameSelector<span class="token punctuation">(</span>num_attribs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token punctuation">(</span><span class="token string">'imputer'</span><span class="token punctuation">,</span> Imputer<span class="token punctuation">(</span>strategy<span class="token operator">=</span><span class="token string">&quot;median&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token punctuation">(</span><span class="token string">'attribs_adder'</span><span class="token punctuation">,</span> CombinedAttributesAdder<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token punctuation">(</span><span class="token string">'std_scaler'</span><span class="token punctuation">,</span> StandardScaler<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

cat_pipeline <span class="token operator">=</span> Pipeline<span class="token punctuation">(</span><span class="token punctuation">[</span>
             <span class="token punctuation">(</span><span class="token string">'selector'</span><span class="token punctuation">,</span> DataFrameSelector<span class="token punctuation">(</span>cat_attribs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token punctuation">(</span><span class="token string">'label_binarizer'</span><span class="token punctuation">,</span> LabelBinarizer<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

full_pipeline <span class="token operator">=</span> FeatureUnion<span class="token punctuation">(</span>transformer_list<span class="token operator">=</span><span class="token punctuation">[</span>
             <span class="token punctuation">(</span><span class="token string">&quot;num_pipeline&quot;</span><span class="token punctuation">,</span> num_pipeline<span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token comment">#            (&quot;cat_pipeline&quot;, cat_pipeline),</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

housing_prepared <span class="token operator">=</span> full_pipeline<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>housing<span class="token punctuation">)</span>
housing_prepared<span class="token punctuation">.</span>shape
</code></pre></div><h2 id="选择和训练模型"><a href="#选择和训练模型" class="header-anchor">#</a> 选择和训练模型</h2> <h3 id="训练和分析训练集"><a href="#训练和分析训练集" class="header-anchor">#</a> 训练和分析训练集</h3> <p>调用线性模型，该模型的 MSE 较大，意味着欠拟合，即特征未提供足够的信息来进行预测，或模型不够强大。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>linear_model <span class="token keyword">import</span> LinearRegression
lin_reg <span class="token operator">=</span> LinearRegression<span class="token punctuation">(</span><span class="token punctuation">)</span>
lin_reg<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>housing_prepared<span class="token punctuation">,</span> housing_labels<span class="token punctuation">)</span>

<span class="token comment"># 对比一些预测数据和他们的标签</span>
some_data <span class="token operator">=</span> housing<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>
some_labels <span class="token operator">=</span> housing_labels<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>
some_data_prepared <span class="token operator">=</span> full_pipeline<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>some_data<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Predictions:\t&quot;</span><span class="token punctuation">,</span> lin_reg<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>some_data_prepared<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Labels:\t\t&quot;</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">(</span>some_labels<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
Predictions<span class="token punctuation">:</span>	 <span class="token punctuation">[</span><span class="token number">206563.06068576</span> <span class="token number">318589.03841011</span> <span class="token number">206073.20582883</span>  <span class="token number">71351.11544056</span>
 <span class="token number">185692.95569414</span><span class="token punctuation">]</span>
Labels<span class="token punctuation">:</span>		 <span class="token punctuation">[</span><span class="token number">286600.0</span><span class="token punctuation">,</span> <span class="token number">340600.0</span><span class="token punctuation">,</span> <span class="token number">196900.0</span><span class="token punctuation">,</span> <span class="token number">46300.0</span><span class="token punctuation">,</span> <span class="token number">254500.0</span><span class="token punctuation">]</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 输出MSE</span>
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> mean_squared_error
housing_predictions <span class="token operator">=</span> lin_reg<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>housing_prepared<span class="token punctuation">)</span>
lin_mse <span class="token operator">=</span> mean_squared_error<span class="token punctuation">(</span>housing_labels<span class="token punctuation">,</span> housing_predictions<span class="token punctuation">)</span>
lin_rmse <span class="token operator">=</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>lin_mse<span class="token punctuation">)</span>
lin_rmse
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
<span class="token number">69422.88161769879</span>
</code></pre></div><p>解决欠拟合的方法为：</p> <ol><li>选择一个更复杂的模型</li> <li>增加其他更好的特征</li> <li>减少模型的限制，该模型没有使用正则化，所以此选项可不考虑</li></ol> <p>下面换一个决策树回归模型（DecisionTreeRegressor）</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>tree <span class="token keyword">import</span> DecisionTreeRegressor
tree_reg <span class="token operator">=</span> DecisionTreeRegressor<span class="token punctuation">(</span><span class="token punctuation">)</span>
tree_reg<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>housing_prepared<span class="token punctuation">,</span> housing_labels<span class="token punctuation">)</span>
housing_predictions <span class="token operator">=</span> tree_reg<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>housing_prepared<span class="token punctuation">)</span>
tree_mse <span class="token operator">=</span> mean_squared_error<span class="token punctuation">(</span>housing_labels<span class="token punctuation">,</span> housing_predictions<span class="token punctuation">)</span>
tree_rmse <span class="token operator">=</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>tree_mse<span class="token punctuation">)</span>
tree_rmse
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
<span class="token number">0.0</span>
</code></pre></div><p>从上面 MSE 为 0 可以看出，该模型过拟合了</p> <h3 id="使用交叉验证评估模型"><a href="#使用交叉验证评估模型" class="header-anchor">#</a> 使用交叉验证评估模型</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> cross_val_score
scores <span class="token operator">=</span> cross_val_score<span class="token punctuation">(</span>tree_reg<span class="token punctuation">,</span> housing_prepared<span class="token punctuation">,</span> housing_labels<span class="token punctuation">,</span>
                             scoring<span class="token operator">=</span><span class="token string">&quot;neg_mean_squared_error&quot;</span><span class="token punctuation">,</span> cv<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
rmse_scores <span class="token operator">=</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token operator">-</span>scores<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">display_scores</span><span class="token punctuation">(</span>scores<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Scores:&quot;</span><span class="token punctuation">,</span> scores<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Mean:&quot;</span><span class="token punctuation">,</span> scores<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Standard deviation:&quot;</span><span class="token punctuation">,</span> scores<span class="token punctuation">.</span>std<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
display_scores<span class="token punctuation">(</span>rmse_scores<span class="token punctuation">)</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
Scores<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">74010.28770706</span> <span class="token number">74680.64882796</span> <span class="token number">74773.57241916</span> <span class="token number">71768.12641187</span>
 <span class="token number">75927.45258799</span> <span class="token number">74781.87802591</span> <span class="token number">73151.93148335</span> <span class="token number">72730.44601226</span>
 <span class="token number">72628.73907481</span> <span class="token number">74100.34761688</span><span class="token punctuation">]</span>
Mean<span class="token punctuation">:</span> <span class="token number">73855.343016726</span>
Standard deviation<span class="token punctuation">:</span> <span class="token number">1199.2342001940942</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 对线性模型使用交叉验证</span>
lin_scores <span class="token operator">=</span> cross_val_score<span class="token punctuation">(</span>lin_reg<span class="token punctuation">,</span> housing_prepared<span class="token punctuation">,</span> housing_labels<span class="token punctuation">,</span>
    scoring<span class="token operator">=</span><span class="token string">&quot;neg_mean_squared_error&quot;</span><span class="token punctuation">,</span> cv<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span> 
lin_rmse_scores <span class="token operator">=</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token operator">-</span>lin_scores<span class="token punctuation">)</span>
display_scores<span class="token punctuation">(</span>lin_rmse_scores<span class="token punctuation">)</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
Scores<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">67383.78417581</span> <span class="token number">67985.10139708</span> <span class="token number">72048.46844728</span> <span class="token number">74992.50810742</span>
 <span class="token number">68535.66280489</span> <span class="token number">71602.89821633</span> <span class="token number">66059.1201932</span>  <span class="token number">69302.44278968</span>
 <span class="token number">72437.02688935</span> <span class="token number">68368.6996472</span> <span class="token punctuation">]</span>
Mean<span class="token punctuation">:</span> <span class="token number">69871.57126682388</span>
Standard deviation<span class="token punctuation">:</span> <span class="token number">2630.4324574585044</span>
</code></pre></div><h3 id="使用随机森林"><a href="#使用随机森林" class="header-anchor">#</a> 使用随机森林</h3> <p><strong>Ensemble Learning</strong>: Building a model on top of many other models</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>ensemble <span class="token keyword">import</span> RandomForestRegressor 
forest_reg <span class="token operator">=</span> RandomForestRegressor<span class="token punctuation">(</span><span class="token punctuation">)</span>
forest_reg<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>housing_prepared<span class="token punctuation">,</span> housing_labels<span class="token punctuation">)</span>
housing_predictions <span class="token operator">=</span> forest_reg<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>housing_prepared<span class="token punctuation">)</span>
forest_mse <span class="token operator">=</span> mean_squared_error<span class="token punctuation">(</span>housing_labels<span class="token punctuation">,</span> housing_predictions<span class="token punctuation">)</span>
forest_rmse <span class="token operator">=</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>forest_mse<span class="token punctuation">)</span>
forest_rmse

forest_scores <span class="token operator">=</span> cross_val_score<span class="token punctuation">(</span>forest_reg<span class="token punctuation">,</span> housing_prepared<span class="token punctuation">,</span> housing_labels<span class="token punctuation">,</span>
    scoring<span class="token operator">=</span><span class="token string">&quot;neg_mean_squared_error&quot;</span><span class="token punctuation">,</span> cv<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span> 
forest_rmse_scores <span class="token operator">=</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token operator">-</span>forest_scores<span class="token punctuation">)</span>
display_scores<span class="token punctuation">(</span>forest_rmse_scores<span class="token punctuation">)</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
Scores<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">52716.39575252</span> <span class="token number">51077.36847995</span> <span class="token number">53916.75005202</span> <span class="token number">55501.91073001</span>
 <span class="token number">52624.70886263</span> <span class="token number">56367.33336096</span> <span class="token number">52139.5370373</span>  <span class="token number">53443.45594517</span>
 <span class="token number">55513.29552081</span> <span class="token number">54751.65501867</span><span class="token punctuation">]</span>
Mean<span class="token punctuation">:</span> <span class="token number">53805.24107600411</span>
Standard deviation<span class="token punctuation">:</span> <span class="token number">1618.473853712107</span>
</code></pre></div><p>解决过拟合的办法：</p> <ol><li>简化模型</li> <li>使用正则化</li> <li>加大训练数据</li></ol> <h2 id="调试模型"><a href="#调试模型" class="header-anchor">#</a> 调试模型</h2> <h3 id="grid-search"><a href="#grid-search" class="header-anchor">#</a> Grid Search</h3> <p>试不同的超参数，直到找到一个最佳组合。使用 <code>GridSearchCV</code>，你只需要设置你想实验的参数，它会使用 CrossValidation 尝试所有可能的组合</p> <p>例如</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> GridSearchCV
<span class="token comment"># 3*4 + 2*3 种组合，每个模型训练 5 次</span>
param_grid <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token string">'n_estimators'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'max_features'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">'bootstrap'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token boolean">False</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'n_estimators'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'max_features'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

forest_reg <span class="token operator">=</span> RandomForestRegressor<span class="token punctuation">(</span><span class="token punctuation">)</span>
grid_search <span class="token operator">=</span> GridSearchCV<span class="token punctuation">(</span>forest_reg<span class="token punctuation">,</span> param_grid<span class="token punctuation">,</span> cv<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>
                               scoring<span class="token operator">=</span><span class="token string">'neg_mean_squared_error'</span><span class="token punctuation">)</span>
grid_search<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>housing_prepared<span class="token punctuation">,</span> housing_labels<span class="token punctuation">)</span>
<span class="token comment"># 查看最佳参数组合</span>
grid_search<span class="token punctuation">.</span>best_params_
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
<span class="token punctuation">{</span><span class="token string">'max_features'</span><span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token string">'n_estimators'</span><span class="token punctuation">:</span> <span class="token number">30</span><span class="token punctuation">}</span>
</code></pre></div><h3 id="重要性分析"><a href="#重要性分析" class="header-anchor">#</a> 重要性分析</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 根据重要性分析，你可以丢弃一些无用的 feature</span>
feature_importances <span class="token operator">=</span> grid_search<span class="token punctuation">.</span>best_estimator_<span class="token punctuation">.</span>feature_importances_
extra_attribs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&quot;rooms_per_hhold&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;pop_per_hhold&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bedrooms_per_room&quot;</span><span class="token punctuation">]</span> 
cat_one_hot_attribs <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>encoder<span class="token punctuation">.</span>classes_<span class="token punctuation">)</span>
attributes <span class="token operator">=</span> num_attribs <span class="token operator">+</span> extra_attribs <span class="token operator">+</span> cat_one_hot_attribs
<span class="token builtin">sorted</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>feature_importances<span class="token punctuation">,</span> attributes<span class="token punctuation">)</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token number">0.4085511709593715</span><span class="token punctuation">,</span> <span class="token string">'median_income'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">(</span><span class="token number">0.1274639391269915</span><span class="token punctuation">,</span> <span class="token string">'pop_per_hhold'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">(</span><span class="token number">0.10153999652040019</span><span class="token punctuation">,</span> <span class="token string">'bedrooms_per_room'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">(</span><span class="token number">0.09974644399457142</span><span class="token punctuation">,</span> <span class="token string">'longitude'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">(</span><span class="token number">0.09803482684236019</span><span class="token punctuation">,</span> <span class="token string">'latitude'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">(</span><span class="token number">0.055005428384214745</span><span class="token punctuation">,</span> <span class="token string">'housing_median_age'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">(</span><span class="token number">0.047782933377019284</span><span class="token punctuation">,</span> <span class="token string">'rooms_per_hhold'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">(</span><span class="token number">0.0165562182216361</span><span class="token punctuation">,</span> <span class="token string">'population'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">(</span><span class="token number">0.01549536838937868</span><span class="token punctuation">,</span> <span class="token string">'total_rooms'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">(</span><span class="token number">0.014996404177845452</span><span class="token punctuation">,</span> <span class="token string">'total_bedrooms'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">(</span><span class="token number">0.014827270006210978</span><span class="token punctuation">,</span> <span class="token string">'households'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><h3 id="在测试集上评估模型"><a href="#在测试集上评估模型" class="header-anchor">#</a> 在测试集上评估模型</h3> <div class="language-python extra-class"><pre class="language-python"><code>final_model <span class="token operator">=</span> grid_search<span class="token punctuation">.</span>best_estimator_
X_test <span class="token operator">=</span> strat_test_set<span class="token punctuation">.</span>drop<span class="token punctuation">(</span><span class="token string">&quot;median_house_value&quot;</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
y_test <span class="token operator">=</span> strat_test_set<span class="token punctuation">[</span><span class="token string">&quot;median_house_value&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
X_test_prepared <span class="token operator">=</span> full_pipeline<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>X_test<span class="token punctuation">)</span>
final_predictions <span class="token operator">=</span> final_model<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>X_test_prepared<span class="token punctuation">)</span>
final_mse <span class="token operator">=</span> mean_squared_error<span class="token punctuation">(</span>y_test<span class="token punctuation">,</span> final_predictions<span class="token punctuation">)</span>
final_rmse <span class="token operator">=</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>final_mse<span class="token punctuation">)</span> <span class="token comment"># =&gt; evaluates to 48,209.6</span>
final_rmse
<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span>
<span class="token number">49746.60716972495</span>
</code></pre></div><p>上预发前，需要展示你的解决方案：</p> <ol><li>你学到了什么</li> <li>什么可行？什么不可行</li> <li>你做了哪些假设</li> <li>系统的限制是什么？</li></ol> <h2 id="上线时需要注意什么"><a href="#上线时需要注意什么" class="header-anchor">#</a> 上线时需要注意什么</h2> <ol><li>持续监控，避免因为数据持续更新，导致模型退化</li> <li>采样预测数据，并对其进行评估，以监控模型效果</li> <li>定期重新训练模型，例如每6个月</li> <li>定期做全量预测</li></ol> <p>以上是该书第二章的学习笔记，你也可以下载 <a href="https://github.com/jieniu/HOML-exercises/blob/master/chapter2/ch2_note.ipynb" target="_blank" rel="noopener noreferrer">Jupyter NoteBook<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 来具体操练一下。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/jieniu/articles/edit/master/docs/AI/homl-ch2.md" target="_blank" rel="noopener noreferrer">在 Github 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">6/1/2019, 12:33:00 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.df58ad8f.js" defer></script><script src="/assets/js/2.61eaf15d.js" defer></script><script src="/assets/js/19.572b0672.js" defer></script>
  </body>
</html>
